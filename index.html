<!DOCTYPE html>
<html>
<head>
  <title>Robotica Lab 2</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map {
    height: 80%;
  }
  .alertify-notifier .ajs-message.ajs-error{
    color: #fff;
    background: rgba(217, 92, 92, 0,95);
    text-shadow: -1px -1px 0 rgba(0, 0, 0, 0,5);
  }
  .alertify-notifier .ajs-message.ajs-success{
    color: #fff;
    background: rgba(217, 92, 92, 0,95);
    text-shadow: -1px -1px 0 rgba(0, 0, 0, 0,5);
  }
  </style>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"> 
  <link rel="stylesheet" href="alertify.min.css">    
  <!-- Latest compiled and minified JavaScript -->
  <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script   src="alertify.min.js"></script>
  
</head>
<body>
  <div class="alert alert-success" align ="center"><h5>Laboratorio 2 Robótica - Drones</h5></div>
  <div id="map" class="container"></div>
  <div class="container">
    <div class="col">
      <div class="row">
        <!--div class="btn btn-success" onclick="agregarArea();">Indicar Area</div>
        <div class="btn btn-warning" onclick="agregarPosInicial();">Indicar Posición Inicial</div-->
        <div class="btn btn-success" data-toggle="modal" data-target="#myModal3">Indicar Área</div>
        <div class="btn btn-warning" data-toggle="modal" data-target="#myModal2">Posición inicial</div>
        <div class="btn btn-danger" data-toggle="modal" data-target="#myModal">Ingresar Obstáculo</div>
        <div class="btn btn-primary pull-right" onclick="generarCamino();">Generar misión</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Indicar área</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">           
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitudA" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitudA" class="form-control">
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitudB" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitudB" class="form-control">
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitudC" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitudC" class="form-control">
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitudD" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitudD" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary"  onclick="agregarArea();" >Agregar</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal -->
  <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Posición inicial</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">           
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitudIni" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitudIni" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary"  onclick="agregarPosInicial();" >Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Nuevo Obstáculo</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="largo">Largo</label>
            <input type="number" name="largo" id="largo" placeholder="metros" min="1" class="form-control">
            <label for="ancho">Ancho</label>
            <input type="number" name="ancho" id="ancho" placeholder="metros" min="1" class="form-control">
            <label for=latitud>Latitud</label>
            <input type="number" name="latitud" id="latitud" class="form-control">
            <label for=longitud>Longitud</label>
            <input type="number" name="longitud" id="longitud" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary"  onclick="agregarObstaculo();" >Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  var map;
  var infoWindow;
  var polygon;
  var area;
  var posInicial;
  var markers=[];
  function initMap() {

    var myLatLng = {lat: -33.5926511, lng: -70.7327125};

    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 13,
      center: myLatLng,
      mapTypeId: google.maps.MapTypeId.SATELLITE

    });
    getLocation();

    infoWindow = new google.maps.InfoWindow();

  }
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }
  function showPosition(position) {
    var lat = position.coords.latitude;
    var lng = position.coords.longitude;
    map.setCenter(new google.maps.LatLng(lat, lng));
  }
  function agregarArea(){
    if(polygon) polygon.setMap(null);
    var longitudA = $("#longitudA").val();
    var latitudA = $("#latitudA").val();
    var longitudB = $("#longitudB").val();
    var latitudB = $("#latitudB").val();
    var longitudC = $("#longitudC").val();
    var latitudC = $("#latitudC").val();
    var longitudD = $("#longitudD").val();
    var latitudD = $("#latitudD").val();

    var ptoA = new google.maps.LatLng(latitudA,longitudA);
    var ptoB =new google.maps.LatLng(latitudB,longitudB);
    var ptoC =new google.maps.LatLng(latitudC,longitudC);
    var ptoD =new google.maps.LatLng(latitudD,longitudD);

  var current=[ptoA,ptoB,ptoC,ptoD];
    //var current = map.getCenter();
    //current =  [{lat: current.lat(), lng: current.lng()},{lat: current.lat(), lng: current.lng()}];
    polygon = new google.maps.Polygon({
      map: map,
      paths: current,
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.35,
      //draggable: true,
      geodesic: true,
      //editable: true
    });
    infoWindow.setContent("Se ha ingresado una nueva area");
    infoWindow.setPosition(map.getCenter());

    infoWindow.open(map);

    setTimeout(function() {

      infoWindow.close(map);
    }, 1500);
    google.maps.event.addListener(polygon, "dragend", getPath);
    google.maps.event.addListener(polygon.getPath(), "insert_at", getPath);
    google.maps.event.addListener(polygon.getPath(), "remove_at", getPath);
    google.maps.event.addListener(polygon.getPath(), "set_at", getPath);
    alertify.success("Se ha ingresado un área");
    $("#myModal3").modal('toggle');
  }
  function getPath(){
    area= polygon.getPath();
    infoWindow.setContent("Se ha cambiado el area");
    infoWindow.setPosition(map.getCenter());

    infoWindow.open(map);

    setTimeout(function() {

      infoWindow.close(map);
    }, 1500);
  }
  function agregarPosInicial(){
    if(posInicial) posInicial.setMap(null);
    var longitud = $("#longitudIni").val();
    var latitud = $("#latitudIni").val();
    var posIni=new google.maps.LatLng(latitud,longitud);
    var iconBase = 'https://maps.google.com/mapfiles/kml/pal2/';
    posInicial = new google.maps.Marker(
    {
      map:map,
      //draggable:true,
      animation: google.maps.Animation.DROP,
      position: posIni,
      icon: iconBase + 'icon56.png'

    });
    google.maps.event.addListener(posInicial, 'dragend', function() 
    {
      posInicial = posInicial
          // Quitar comentario para mirar posición
          //alertify.success(markers[len][2].getPosition().toString());

        });
    alertify.success("Se ha ingresado posición inicial con éxito");
    $("#myModal2").modal('toggle');
  }
  function agregarObstaculo(){
    var largo = $("#largo").val();
    var ancho = $("#ancho").val();
    var latitud = $("#latitud").val();
    var longitud = $("#longitud").val();    
    var marcador=new google.maps.LatLng(latitud,longitud);

    if (ancho < 1 || largo < 1 ){
      alertify.error('Debe ingresar alto o ancho');
    }
    else{
      var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
      var len = markers.length;
      var temp = []
      temp.push(len);
      temp.push([largo,ancho]);
      temp.push(new google.maps.Marker(
      {
        map:map,
        //draggable:true,
        animation: google.maps.Animation.DROP,
        position: marcador,
        icon: iconBase + 'schools_maps.png'

      }));
      markers.push(temp);

      var infowindow = new google.maps.InfoWindow({
        content: '<p>Obstáculo N°:' + markers[len][0] + ' Largo: ' + markers[len][1][0] +' Ancho: ' +markers[len][1][1]+'<br> Posición: '+ markers[len][2].getPosition() +'</p>'
      });
      google.maps.event.addListener(markers[len][2], 'dragend', function(event) 
      {
        markers[len][2].setPosition(event.latLng);
          // Quitar comentario para mirar posición
          //alertify.success(markers[len][2].getPosition().toString());
          infowindow = new google.maps.InfoWindow({
            content: '<p>Obstáculo N°:' + markers[len][0] + ' Largo: ' + markers[len][1][0] +' Ancho: ' +markers[len][1][1]+'<br> Posición: '+ markers[len][2].getPosition() +'</p>'
          });
        });


      google.maps.event.addListener(markers[len][2], 'click', function() {
        infowindow.open(map, markers[len][2]);
        setTimeout(function() {

          infowindow.close(map);
        }, 1000);
      });
      alertify.success("Se ha ingresado Obstáculo con éxito");
      $("#myModal").modal('toggle');
    }
  }
////////////////////////////////////////////////////
///////// ALGORITMO QUE CALCULA EL CAMINO //////////
////////////////////////////////////////////////////
var poly;
function generarCamino() {
  console.log(polygon);
  console.log(area);
  console.log(posInicial);
  if(polygon != null &&  posInicial!= null){
      poly = new google.maps.Polyline({
      strokeColor: '#FFFF00',
      strokeOpacity: 1.0,
      strokeWeight: 3
      });
      poly.setMap(map);
      var path = poly.getPath();
      path.push(posInicial.getPosition());
      var lat = posInicial.getPosition().lat();
      var lng = posInicial.getPosition().lng();
      for (var i = 0; i < 100; i++) {
        var locat = new google.maps.LatLng(lat+(i/1000),lng);
        path.push(locat);
      };

       
    }
    else{
      alertify.error("Debe ingresar una área y una posición inicial");
    }
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNU3lXIG8aBek6Zf67cufU8IjM8OlvlcQ&callback=initMap"
async defer></script>
</body>
</html>